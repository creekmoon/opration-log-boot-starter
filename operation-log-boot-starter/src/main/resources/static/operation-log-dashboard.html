<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operation Log Dashboard</title>
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --border-color: #e0e0e0;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-hover: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --border-color: #2d2d44;
            --shadow: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-hover: 0 4px 16px rgba(0,0,0,0.4);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }
        
        .header {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 { font-size: 1.5rem; font-weight: 600; }
        
        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .btn:hover { background: rgba(255,255,255,0.3); }
        .btn.active { background: rgba(255,255,255,0.4); }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 2s infinite;
        }
        
        .status-dot.disconnected {
            background: #f56565;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .time-selector {
            display: flex;
            gap: 0.5rem;
        }
        
        .time-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .time-btn:hover, .time-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .card-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card-change {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .card-change.positive { color: #48bb78; }
        .card-change.negative { color: #f56565; }
        
        .chart-card {
            grid-column: span 2;
        }
        
        @media (max-width: 768px) {
            .chart-card { grid-column: span 1; }
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }
        
        th:hover {
            color: var(--accent-primary);
        }
        
        tr:hover {
            background: var(--bg-primary);
        }
        
        .rank {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .rank.top1 { background: #ffd700; color: #333; }
        .rank.top2 { background: #c0c0c0; color: #333; }
        .rank.top3 { background: #cd7f32; color: white; }
        .rank.other { background: var(--bg-primary); color: var(--text-secondary); }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Operation Log Dashboard</h1>
        <div class="header-controls">
            <div class="connection-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">ÂÆûÊó∂ËøûÊé•‰∏≠</span>
            </div>
            <button class="btn" id="themeToggle">üåô ÊöóËâ≤</button>
            <button class="btn" id="pauseBtn">‚è∏ ÊöÇÂÅú</button>
        </div>
    </div>
    
    <div class="container">
        <div class="toolbar">
            <div class="time-selector">
                <button class="time-btn active" data-range="realtime">ÂÆûÊó∂</button>
                <button class="time-btn" data-range="hourly">1Â∞èÊó∂</button>
                <button class="time-btn" data-range="daily">24Â∞èÊó∂</button>
            </div>
            <span style="color: var(--text-secondary); font-size: 0.875rem;">
                ÊúÄÂêéÊõ¥Êñ∞: <span id="lastUpdate">--</span>
            </span>
        </div>
        
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">ÊÄª PV</span>
                </div>
                <div class="card-value" id="totalPv">--</div>
                <div class="card-change positive" id="pvChange">‚Üë --%</div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">ÊÄª UV</span>
                </div>
                <div class="card-value" id="totalUv">--</div>
                <div class="card-change positive" id="uvChange">‚Üë --%</div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Ê¥ªË∑ÉÊé•Âè£</span>
                </div>
                <div class="card-value" id="activeEndpoints">--</div>
                <div class="card-change">ÂÆûÊó∂ÁõëÊéß‰∏≠</div>
            </div>
            
            <div class="card chart-card">
                <div class="card-header">
                    <span class="card-title">PV/UV Ë∂ãÂäø</span>
                </div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            
            <div class="card chart-card">
                <div class="card-header">
                    <span class="card-title">ÁÉ≠Èó®Êé•Âè£ Top 10</span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ÊéíÂêç</th>
                                <th>Êé•Âè£</th>
                                <th onclick="sortTable('pv')">PV ‚Üï</th>
                                <th onclick="sortTable('uv')">UV ‚Üï</th>
                            </tr>
                        </thead>
                        <tbody id="topTable">
                            <tr><td colspan="4" style="text-align:center;color:var(--text-secondary)">Âä†ËΩΩ‰∏≠...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>

    <script>
        // ==================== ÂéüÁîü Canvas ÂõæË°®Â∫ì ====================
        class SimpleChart {
            constructor(canvasId, options = {}) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.options = {
                    padding: { top: 20, right: 20, bottom: 40, left: 60 },
                    colors: ['#667eea', '#764ba2', '#48bb78', '#f56565'],
                    ...options
                };
                this.data = [];
                this.hoverIndex = -1;
                
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.canvas.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                this.canvas.addEventListener('mouseleave', () => this.handleMouseLeave());
            }
            
            resize() {
                const rect = this.canvas.parentElement.getBoundingClientRect();
                this.canvas.width = rect.width * window.devicePixelRatio;
                this.canvas.height = rect.height * window.devicePixelRatio;
                this.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
                this.width = rect.width;
                this.height = rect.height;
                this.draw();
            }
            
            setData(data) {
                this.data = data;
                this.draw();
            }
            
            draw() {
                if (!this.data.length) return;
                
                this.ctx.clearRect(0, 0, this.width, this.height);
                
                const { padding } = this.options;
                const chartWidth = this.width - padding.left - padding.right;
                const chartHeight = this.height - padding.top - padding.bottom;
                
                // ËÆ°ÁÆóÊúÄÂ§ßÂÄº
                const maxValue = Math.max(...this.data.flatMap(d => [d.pv, d.uv])) * 1.1;
                
                // ÁªòÂà∂ÁΩëÊ†ºÁ∫ø
                this.ctx.strokeStyle = 'rgba(128,128,128,0.1)';
                this.ctx.lineWidth = 1;
                for (let i = 0; i <= 5; i++) {
                    const y = padding.top + (chartHeight * i / 5);
                    this.ctx.beginPath();
                    this.ctx.moveTo(padding.left, y);
                    this.ctx.lineTo(this.width - padding.right, y);
                    this.ctx.stroke();
                    
                    // YËΩ¥Ê†áÁ≠æ
                    this.ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-secondary');
                    this.ctx.font = '12px sans-serif';
                    this.ctx.textAlign = 'right';
                    this.ctx.fillText(Math.round(maxValue * (5-i) / 5), padding.left - 10, y + 4);
                }
                
                // ÁªòÂà∂ÊäòÁ∫ø
                ['pv', 'uv'].forEach((key, idx) => {
                    this.ctx.strokeStyle = this.options.colors[idx];
                    this.ctx.lineWidth = 2;
                    this.ctx.beginPath();
                    
                    this.data.forEach((point, i) => {
                        const x = padding.left + (chartWidth * i / (this.data.length - 1));
                        const y = padding.top + chartHeight - (chartHeight * point[key] / maxValue);
                        
                        if (i === 0) this.ctx.moveTo(x, y);
                        else this.ctx.lineTo(x, y);
                    });
                    
                    this.ctx.stroke();
                    
                    // ÁªòÂà∂Êï∞ÊçÆÁÇπ
                    this.ctx.fillStyle = this.options.colors[idx];
                    this.data.forEach((point, i) => {
                        const x = padding.left + (chartWidth * i / (this.data.length - 1));
                        const y = padding.top + chartHeight - (chartHeight * point[key] / maxValue);
                        
                        this.ctx.beginPath();
                        this.ctx.arc(x, y, i === this.hoverIndex ? 6 : 4, 0, Math.PI * 2);
                        this.ctx.fill();
                    });
                });
                
                // ÁªòÂà∂ X ËΩ¥Ê†áÁ≠æ
                this.ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-secondary');
                this.ctx.textAlign = 'center';
                this.data.forEach((point, i) => {
                    if (i % Math.ceil(this.data.length / 6) === 0) {
                        const x = padding.left + (chartWidth * i / (this.data.length - 1));
                        this.ctx.fillText(point.time, x, this.height - padding.bottom + 20);
                    }
                });
                
                // ÁªòÂà∂Âõæ‰æã
                this.drawLegend();
            }
            
            drawLegend() {
                const legendItems = [
                    { label: 'PV', color: this.options.colors[0] },
                    { label: 'UV', color: this.options.colors[1] }
                ];
                
                let x = this.width - this.options.padding.right - 100;
                const y = this.options.padding.top;
                
                legendItems.forEach(item => {
                    this.ctx.fillStyle = item.color;
                    this.ctx.fillRect(x, y - 6, 12, 12);
                    this.ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-primary');
                    this.ctx.font = '12px sans-serif';
                    this.ctx.textAlign = 'left';
                    this.ctx.fillText(item.label, x + 18, y + 4);
                    x += 50;
                });
            }
            
            handleMouseMove(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) * window.devicePixelRatio;
                const { padding } = this.options;
                const chartWidth = this.width - padding.left - padding.right;
                
                const index = Math.round(((x - padding.left) / chartWidth) * (this.data.length - 1));
                
                if (index >= 0 && index < this.data.length && index !== this.hoverIndex) {
                    this.hoverIndex = index;
                    this.draw();
                    this.showTooltip(e, this.data[index]);
                }
            }
            
            handleMouseLeave() {
                this.hoverIndex = -1;
                this.draw();
                document.getElementById('tooltip').style.opacity = '0';
            }
            
            showTooltip(e, data) {
                const tooltip = document.getElementById('tooltip');
                tooltip.innerHTML = `
                    <strong>${data.time}</strong><br>
                    PV: ${data.pv.toLocaleString()}<br>
                    UV: ${data.uv.toLocaleString()}
                `;
                tooltip.style.left = e.pageX + 10 + 'px';
                tooltip.style.top = e.pageY - 30 + 'px';
                tooltip.style.opacity = '1';
            }
        }

        // ==================== SSE ÂÆûÊó∂ËøûÊé• ====================
        class DashboardStream {
            constructor() {
                this.eventSource = null;
                this.isPaused = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.connect();
            }
            
            connect() {
                if (this.eventSource) {
                    this.eventSource.close();
                }
                
                this.eventSource = new EventSource('/operation-log/dashboard/stream');
                
                this.eventSource.onopen = () => {
                    console.log('SSE ËøûÊé•Â∑≤Âª∫Á´ã');
                    this.updateStatus(true);
                    this.reconnectAttempts = 0;
                };
                
                this.eventSource.addEventListener('dashboard-update', (e) => {
                    if (!this.isPaused) {
                        const data = JSON.parse(e.data);
                        updateDashboard(data);
                    }
                });
                
                this.eventSource.onerror = () => {
                    console.error('SSE ËøûÊé•ÈîôËØØ');
                    this.updateStatus(false);
                    this.eventSource.close();
                    
                    // Ëá™Âä®ÈáçËøû
                    if (this.reconnectAttempts < this.maxReconnectAttempts) {
                        this.reconnectAttempts++;
                        setTimeout(() => this.connect(), 3000 * this.reconnectAttempts);
                    }
                };
            }
            
            updateStatus(connected) {
                const dot = document.getElementById('statusDot');
                const text = document.getElementById('statusText');
                
                if (connected) {
                    dot.classList.remove('disconnected');
                    text.textContent = 'ÂÆûÊó∂ËøûÊé•‰∏≠';
                } else {
                    dot.classList.add('disconnected');
                    text.textContent = 'ËøûÊé•Êñ≠ÂºÄÔºåÈáçËøû‰∏≠...';
                }
            }
            
            pause() {
                this.isPaused = true;
            }
            
            resume() {
                this.isPaused = false;
            }
        }

        // ==================== Dashboard ÈÄªËæë ====================
        let trendChart;
        let stream;
        let currentData = null;
        let previousData = null;
        
        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            trendChart = new SimpleChart('trendChart');
            stream = new DashboardStream();
            
            // ‰∏ªÈ¢òÂàáÊç¢
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // ÊöÇÂÅú/ÁªßÁª≠
            document.getElementById('pauseBtn').addEventListener('click', togglePause);
            
            // Êó∂Èó¥ËåÉÂõ¥ÈÄâÊã©
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    // TODO: ÂàáÊç¢Êó∂Èó¥ËåÉÂõ¥Êï∞ÊçÆ
                });
            });
        });
        
        function updateDashboard(data) {
            previousData = currentData;
            currentData = data;
            
            // Êõ¥Êñ∞ÊåáÊ†áÂç°Áâá
            document.getElementById('totalPv').textContent = data.totalPv.toLocaleString();
            document.getElementById('totalUv').textContent = data.totalUv.toLocaleString();
            document.getElementById('activeEndpoints').textContent = data.activeEndpoints;
            
            // ËÆ°ÁÆóÂèòÂåñÁéá
            if (previousData) {
                updateChange('pvChange', data.totalPv, previousData.totalPv);
                updateChange('uvChange', data.totalUv, previousData.totalUv);
            }
            
            // Êõ¥Êñ∞Êó∂Èó¥
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            // Êõ¥Êñ∞ÂõæË°®
            if (data.trend && data.trend.length > 0) {
                trendChart.setData(data.trend);
            }
            
            // Êõ¥Êñ∞Ë°®Ê†º
            updateTopTable(data.topPvList || []);
        }
        
        function updateChange(elementId, current, previous) {
            const el = document.getElementById(elementId);
            const change = previous > 0 ? ((current - previous) / previous * 100).toFixed(1) : 0;
            const isPositive = change >= 0;
            
            el.textContent = (isPositive ? '‚Üë' : '‚Üì') + ' ' + Math.abs(change) + '%';
            el.className = 'card-change ' + (isPositive ? 'positive' : 'negative');
        }
        
        function updateTopTable(list) {
            const tbody = document.getElementById('topTable');
            if (!list.length) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-secondary)">ÊöÇÊó†Êï∞ÊçÆ</td></tr>';
                return;
            }
            
            tbody.innerHTML = list.map((item, idx) => `
                <tr>
                    <td><span class="rank ${idx < 3 ? 'top' + (idx+1) : 'other'}">${idx + 1}</span></td>
                    <td>${item.fullName}</td>
                    <td>${item.value.toLocaleString()}</td>
                    <td>--</td>
                </tr>
            `).join('');
        }
        
        function toggleTheme() {
            const body = document.body;
            const btn = document.getElementById('themeToggle');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                btn.textContent = 'üåô ÊöóËâ≤';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                btn.textContent = '‚òÄÔ∏è ‰∫ÆËâ≤';
                localStorage.setItem('theme', 'dark');
            }
            
            // ÈáçÁªòÂõæË°®
            if (trendChart) trendChart.draw();
        }
        
        function togglePause() {
            const btn = document.getElementById('pauseBtn');
            
            if (stream.isPaused) {
                stream.resume();
                btn.textContent = '‚è∏ ÊöÇÂÅú';
            } else {
                stream.pause();
                btn.textContent = '‚ñ∂Ô∏è ÁªßÁª≠';
            }
        }
        
        function sortTable(column) {
            // TODO: ÂÆûÁé∞Ë°®Ê†ºÊéíÂ∫è
            console.log('ÊéíÂ∫è:', column);
        }
        
        // Âä†ËΩΩ‰øùÂ≠òÁöÑ‰∏ªÈ¢ò
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('themeToggle').textContent = '‚òÄÔ∏è ‰∫ÆËâ≤';
        }
    </script>
</body>
</html>

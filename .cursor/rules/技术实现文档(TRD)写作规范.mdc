---
description: 技术实现文档（TRD）写作规范（架构/模块/接口契约层面，不讨论代码细节）
globs: doc/**/*.md
type: tech-spec
alwaysApply: false
---

# 技术实现文档（TRD）写作规范（架构视角、模块边界）

## 更新记录

- **2026-02-26**：初版发布，与《业务向PRD写作规范》配套使用，明确技术文档的边界与颗粒度。
- **2026-02-27**：重写“面向人类读者”的结构：图+表+总结先行，渐进式展开，话术精简，降低阅读心理负担。

## 适用范围

- **适用对象**：架构师、技术组长、核心开发（默认读者具备技术背景，但不关注具体代码实现）
- **适用场景**：
  - PRD评审通过后，技术方案设计阶段
  - 跨团队/跨模块协作前的接口对齐
  - 复杂业务的技术方案评审（需要架构决策时）
  - 遗留系统的模块重构/技术债务梳理

## 与PRD的关系

| 维度 | PRD（业务向） | TRD（技术向） |
|------|--------------|---------------|
| **读者** | 业务、产品、运营 | 架构师、技术组长、核心开发 |
| **回答的问题** | "做什么"、"业务规则是什么" | "怎么做（架构层面）"、"模块如何划分"、"边界在哪里" |
| **内容来源** | 业务需求、运营规则 | PRD + 技术约束 + 架构演进规划 |
| **评审目标** | 业务可行性、规则完整性 | 技术可行性、扩展性、风险点 |

**关键原则**：TRD 必须在 PRD 定稿后编写，**以PRD为输入**，不篡改业务规则，只补充技术实现方案。

## 写作定位（先纠偏）

TRD 不是“把实现写全”，而是让读者**快速建立心智模型**，并能无负担地往下看：

- **1分钟**：知道方案主链路、模块边界、关键风险
- **5分钟**：知道模块如何协作、接口如何对齐、关键决策为何这么选
- **15分钟**：可以参与评审与任务拆分

## 读者体验原则（必须遵守）

- **结论先行**：先给总结性内容，再展开；不要让读者“读到最后才知道重点”
- **图+表优先**：关系用图，清单用表；段落只解释“为什么/取舍/风险”
- **渐进式披露**：越往后越细，但不跨越 TRD 红线；同一信息不要重复出现
- **降低心理负担（硬约束）**：
  - 单段 ≤ 5 行
  - 单列表 ≤ 7 条（超过就分组/合表/拆文档）
  - 单张图 ≤ 12 个节点（超过就分层）
- **话术精简/精准/简洁**：一句话只表达一个结论；避免长段叙述

## 颗粒度红线（写到这里就停）

TRD 只回答这些问题（写清楚即可）：

- **模块划分**：系统拆分为哪些模块/服务/子系统，每个的职责范围
- **接口契约**：模块间交互的接口定义（入参/出参/错误码/调用方式），但不写具体字段校验逻辑
- **数据流向**：核心业务数据如何在模块间流转（可结合时序图）
- **状态与事件**：业务状态迁移由谁负责、通过什么机制（事件/消息/状态机）
- **非功能性需求**：性能指标、并发预期、容错策略、降级方案
- **依赖与风险**：外部系统依赖、技术债、潜在阻塞点

以下内容默认 **不属于 TRD**（应迁出到其他文档）：

- **具体代码实现**：类名、方法名、SQL语句、ORM配置、具体的算法逻辑
- **数据库表结构**：表名、字段定义、索引设计（这些属于详细设计或DB设计文档）
- **接口的逐字段校验逻辑**：如"字段A长度不能超过50"这类规则（若PRD未规定，应在开发阶段确定）
- **单元测试用例**：测试策略可以提，具体用例在测试文档中
- **部署脚本/配置项**：属于运维文档或配置中心管理内容

判断是否"写得太细"的快速标准：

- 如果一段内容可以直接被开发人员复制粘贴成代码，就写得太细了。
- 如果一段内容是"某个类如何实现"而不是"某个模块提供什么能力"，就应该从 TRD 迁出。

## 禁止项（不要写）

- **不要出现**：具体的类名、方法签名、SQL语句、框架注解、配置项key名
- **不要画**：代码调用链路图、类图（UML Class Diagram）、ER图（除非用于表达模块间关系而非数据结构）
- **不要罗列**：接口的每一个字段校验规则、每一个错误码对应的提示文案
- **不要写**：具体的部署IP、密码、密钥等敏感信息
- **不要重复**：PRD中已经详细描述的业务场景（只引用，如"见PRD第X章场景Y"）

## 文档顶部固定结构（必须有，一屏读完）

1. **标题**：`# <模块/功能> 技术实现文档`
2. **元信息**（四行）：
   - **文档类型**：技术实现文档
   - **关联PRD**：[链接到对应PRD文档]
   - **适用对象**：架构师、技术组长、核心开发
   - **评审状态**：草稿/评审中/已批准/已归档
3. **版本记录表**（必须放顶部，便于追溯）：

| 版本号 | 更新时间 | 作者 | 备注 |
|--------|----------|------|------|
| v1.0 | yyyy-MM-dd | 姓名 | 初版/架构对齐后更新 |

4. **变更摘要**（与上一版本相比的关键变化，3-5条bullet）：
   - 模块X职责调整：原本负责A，现拆分为X负责A1，Y负责A2
   - 接口变更：新增接口Z用于支持PRD中的XX场景

## 推荐章节结构（强制渐进式）

### 0）一屏摘要（必须有，优先级最高）

按“**总结 → 图 → 表**”的顺序组织，读者扫一遍就能继续往下读：

- **一句话方案**：用 1 句描述主链路（建议格式：`入口 → 认证/鉴权 → 核心处理 → 隔离/一致性 → 输出`）
- **系统交互图（1张）**：只画“外部系统/入口/核心模块/存储”，不画细碎内部组件
- **3张表（必填）**：
  - **关键决策（ADR）表**：方案A vs 备选B/C + 选择理由（3-7行）
  - **模块职责表**：模块、职责一句话、输入/输出、边界（5-9行）
  - **接口清单表**：接口/事件、调用方向、方式、目的、鉴权/隔离、幂等/重试、失败策略（不展开字段）

#### 图的要求（为了“好读”，不是为了“全”）

- 默认 1 张图足够；只有“难理解的流程”才补第 2 张关键流程图
- 节点 ≤ 12；超过就分层拆图
- 图里只放名词与方向箭头；解释放图下 3 行内

```mermaid
graph TB
    External[外部调用方] -->|HTTP| Entry[入口/适配层]
    Entry --> Auth[认证/鉴权]
    Entry --> Biz[核心业务编排/委托]
    Biz --> DB[(主库)]
    Auth --> Cache[(缓存/会话)]
```

### 1）需求-技术映射（可选，建议保留但要短）

- **PRD核心点**：3-5条（只写关键词）
- **技术策略**：每条 1 句话（只写策略/机制/边界，不写实现细节）

| PRD需求 | 技术实现要点 |
|---------|-------------|
| 销售只能看到自己负责的客户 | 查询统一加“客户范围”过滤，由权限模块提供范围 |
| 指派关系支持有效期 | 范围计算时按有效期裁剪，过期自动失效 |

### 2）模块划分与职责边界（必须短）

优先用“模块职责表”，然后只对**关键 1-3 个模块**补充说明（每个模块 ≤ 12 行）。

#### 模块X：[模块名称]

- **职责**：一句话（负责什么）
- **边界**：一句话（不负责什么）
- **对外能力**：1-3条（接口/事件名 + 用途 + 调用方）
- **依赖**：依赖谁做什么

### 3）接口契约（必须表格化）

| 接口/事件 | 调用方向 | 方式 | 目的 | 鉴权/隔离 | 幂等/重试 | 失败策略 |
|-----------|----------|------|------|-----------|-----------|----------|
| XXX | A → B | 同步HTTP/RPC | 做什么 | 依赖什么身份 | 是否幂等 | 降级/告警/返回 |

### 4）NFR 与风险（合并为一页）

用表格表达 NFR；风险用 3-7 条 bullet 表达（每条包含“影响 + 缓解”）。

| 维度 | 要求 | 实现策略 |
|------|------|----------|
| 性能 | 目标：P99/吞吐 | 缓存/并发/超时/降级 |
| 安全 | 不越权/可审计 | 统一鉴权 + 审计日志 |
| 稳定性 | 依赖故障不拖垮主链路 | 限流/熔断/降级 |

### 5）演进规划（可选，但要短）

- **当前版本（MVP）**：一句话说明最小可用
- **后续迭代**：3-5条方向（不写实施细节）

## 与PRD的衔接检查清单

在提交TRD评审前，确认以下事项：

- [ ] 已关联对应的PRD文档，且PRD状态为"已批准"
- [ ] TRD中的技术方案能完整支撑PRD中的所有业务规则
- [ ] 对于PRD中的约束条件（如有效期、权限范围），TRD中有对应的技术实现策略
- [ ] 未在TRD中重复描述PRD的业务场景（只引用）
- [ ] TRD中提到的接口/能力与PRD中的角色/操作能对应上

## 话术与表达（让人读得快）

- **推荐表达**：
  - “入口层只做适配与鉴权，业务仍由既有服务处理”
  - “隔离维度为公司；所有查询必须带 company 条件（由统一能力注入）”
  - “失败策略：降级为 X，不阻塞主链路，并告警”
  - “选择 A 而非 B：因为 XXX（1 句话）”
- **避免表达**：
  - "使用`@Service`注解定义类`CustomerServiceImpl`"
  - "SQL语句为：`SELECT * FROM customer WHERE id IN (...)`"
  - "字段`createTime`使用`@JsonFormat`格式化"
  - "缓存key为`customer:range:{userId}`，过期时间3600秒"

## 字数与拆分建议（强约束）

- **MVP TRD 建议 ≤ 150 行**：超出优先“合表/删图/删叙述”，不要用长文堆信息
- 需要字段级/实现级细节时，拆出独立文档：
  - **详细设计（DD）**：字段级契约、校验规则、异常码、边界Case
  - **DB 设计**：表结构/索引/迁移
  - **对接文档**：第三方联调、示例请求响应、签名/加密细节

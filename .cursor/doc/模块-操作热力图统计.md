# 模块-操作热力图统计

## 0. 模块目标

基于 Redis HyperLogLog 实现接口级别的 PV/UV 实时统计，支持多时间窗口（实时/小时/天级）和 TopN 热度排名。

## 1. 边界

- **包含**：PV/UV 统计、TopN 排行、历史趋势查询、采样率控制、Redis 故障降级、Actuator 监控端点
- **不包含**：接口性能耗时统计、用户地理位置分析、可视化图表渲染

## 2. 可检索关键词

`HeatmapService` / `HeatmapCollector` / `HeatmapProperties` / `HeatmapConfiguration` / `HeatmapActuatorEndpoint` / `HeatmapDataCleanupTask` / HyperLogLog / PFADD / PFCOUNT / PV / UV / 采样率 / 降级缓存 / `@OperationLog(heatmap = true)` / `/actuator/operation-log-heatmap`

## 3. 已实现能力(DONE)

- **PV/UV 实时统计**：基于 Redis HyperLogLog（固定 12KB/Key），支持 `PFADD` 写入用户 ID，`PFCOUNT` 读取 UV（锚点：`HeatmapServiceImpl#recordAccess`）
- **多时间窗口**：实时（1分钟窗口，保留24h）、小时级（保留7天）、天级（保留90天）（锚点：`HeatmapProperties#realtimeRetentionHours` / `hourlyRetentionDays` / `dailyRetentionDays`）
- **TopN 接口排行**：按 PV 排序返回最热门的接口列表（锚点：`HeatmapServiceImpl#getTopN`）
- **采样率控制**：可配置 0.0-1.0 的采样率，降低高频接口的 Redis 压力（锚点：`HeatmapProperties#sampleRate`）
- **Redis 故障降级**：Redis 不可用时自动降级到本地 Caffeine 缓存（锚点：`HeatmapServiceImpl` 中 `redisTemplate.hasKey()` 异常捕获分支）
- **数据自动清理**：每小时执行定时任务清理过期数据（锚点：`HeatmapDataCleanupTask#cleanup`）
- **Actuator 监控端点**：暴露 `/actuator/operation-log-heatmap/*` 供运维查询（锚点：`HeatmapActuatorEndpoint`）
- **AOP 集成**：通过 `HeatmapCollector` 在 `LogAspect` 中异步收集数据（锚点：`HeatmapCollector#collect`）

## 4. 主要入口与关键类

- `cn.creekmoon.operationLog.heatmap.HeatmapService` - 服务接口定义
- `cn.creekmoon.operationLog.heatmap.HeatmapServiceImpl` - 服务实现（PV/UV 统计核心）
- `cn.creekmoon.operationLog.heatmap.HeatmapCollector` - 数据收集器（与 LogAspect 集成）
- `cn.creekmoon.operationLog.heatmap.HeatmapProperties` - 配置属性类
- `cn.creekmoon.operationLog.heatmap.HeatmapConfiguration` - 自动配置类
- `cn.creekmoon.operationLog.heatmap.HeatmapActuatorEndpoint` - Actuator 监控端点
- `cn.creekmoon.operationLog.heatmap.HeatmapDataCleanupTask` - 定时清理任务

## 5. 核心流程（高层）

1. 应用启动时 `HeatmapConfiguration` 条件装配所有组件（需 `operation-log.heatmap.enabled=true`）
2. Controller 方法标注 `@OperationLog(heatmap = true)` 被调用
3. `LogAspect` 拦截后调用 `HeatmapCollector#collect` 异步收集数据
4. `HeatmapServiceImpl#recordAccess` 根据采样率决定是否记录
5. 写入 Redis HyperLogLog（`PFADD`），失败则降级到本地缓存
6. 每小时 `HeatmapDataCleanupTask` 清理过期数据
7. 通过 `HeatmapActuatorEndpoint` 暴露查询接口

## 6. 外部依赖

- Redis（HyperLogLog 命令：PFADD、PFCOUNT、PFMERGE）
- Spring Boot Actuator
- Caffeine（本地降级缓存）

## 7. 模块协作点

- **触发点**：`LogAspect#around` 中调用 `HeatmapCollector#collect`
- **输入**：`LogRecord`（提取 className、methodName、userId）
- **输出**：Redis HyperLogLog Key（格式：`heatmap:{window}:{class}:{method}`）
- **一致性约束**：采样率在应用启动时确定，运行期不变

## 8. 常见问题

- **为什么 UV 统计不准确**：HyperLogLog 是概率数据结构，标准误差约 0.81%，看 `HeatmapServiceImpl` 中的 HyperLogLog 使用方式
- **为什么 Redis 挂了数据还能查**：看 `HeatmapServiceImpl` 中 `try-catch` 包裹 Redis 操作的分支，降级到 `localCache`
- **如何调整数据保留时间**：修改 `HeatmapProperties` 中的 `realtimeRetentionHours` / `hourlyRetentionDays` / `dailyRetentionDays`
- **如何查看 TopN 排行**：访问 `GET /actuator/operation-log-heatmap/topn`

# operation-log-starter（operation-log-boot-starter）业务开发总结

## 0. 一句话定位

这是一个 **Spring Boot 3 Starter 库**：通过在 Controller 方法上标注 `@OperationLog`，由 `LogAspect` AOP 切面在运行时采集调用信息（入参/返回值/用户信息/前后值），并异步分发给一个或多个 `OperationLogHandler` 处理。

## 1. 系统边界

- **包含**：注解 + AOP 拦截、日志对象 `LogRecord`、请求级上下文 `OperationLogContext`、异步线程池 `LogThreadPool`、扩展点（初始化器/处理器）、操作热力图统计、用户行为画像
- **不包含**：任何持久化实现（DB/ES/MQ 等）、鉴权/用户解析实现、字段差异对比算法（当前只保存 `preValue/afterValue`）

## 2. 业务域/模块总览

| 模块 | 说明 | 入口文档 |
|---|---|---|
| 启用与装配 | `@EnableOperationLog` 显式导入配置并启用上下文 | [模块-启用与装配](模块-启用与装配.md) |
| AOP切面与采集 | 拦截 `@OperationLog` 方法，采集参数/结果/异常/操作名 | [模块-AOP切面与采集](模块-AOP切面与采集.md) |
| 上下文与字段跟踪 | `ThreadLocal` 维护请求级状态，`follow()` 采集前后值 | [模块-上下文与字段跟踪](模块-上下文与字段跟踪.md) |
| 异步处理与扩展点 | 线程池异步触发多个处理器；初始化器定义用户等信息 | [模块-异步处理与扩展点](模块-异步处理与扩展点.md) |
| 日志数据结构与序列化 | `LogRecord` 字段与 `toFlatJson()` 的存储友好序列化 | [模块-日志数据结构与序列化](模块-日志数据结构与序列化.md) |
| 操作热力图统计 | 基于 Redis HyperLogLog 的 PV/UV 统计、TopN 排行 | [模块-操作热力图统计](模块-操作热力图统计.md) |
| 用户行为画像 | 用户操作聚合、可配置标签规则引擎 | [模块-用户行为画像](模块-用户行为画像.md) |

## 3. 主流程（已实现）

1. 应用启动类添加 `@EnableOperationLog`（`config/EnableOperationLog`），导入 `OperationLogAutoConfiguration` 与 `OperationLogConfig`
2. `OperationLogAutoConfiguration#init()` 将 `OperationLogContext.disable` 置为 `false`，并注册 `LogAspect` / 默认处理器 / 默认初始化器
3. Controller 方法标注 `@OperationLog` 后被调用 → `LogAspect#around()` 拦截
4. `LogAspect` 创建 `LogRecord` 并通过 `OperationLogRecordInitializer#init()` 初始化（通常设置 userId/userName/projectName 等）
5. 采集方法名/类名/操作名、序列化入参到 `LogRecord.requestParams`
6. 执行原方法：成功则调用 `OperationLogRecordInitializer#functionPostProcess()`；异常则将 `requestResult=false` 并按 `handleOnFail` 决定是否记录异常到 `remarks`
7. 如果需要记录：可选地从 `OperationLogContext.follow()` 注册的 supplier 读取 afterValue；然后 `LogThreadPool.runTask()` 异步调用所有 `OperationLogHandler#handle()`
8. `OperationLogContext.clean()` 清理 ThreadLocal 与缓存 map

## 4. 横切关注点（已实现）

- **嵌套注解跳过**：同一线程内若已存在 `LogRecord`，内层 `@OperationLog` 直接 `proceed()` 不再记录（`LogAspect#around()`）
- **异步执行策略**：线程池拒绝策略为 `CallerRunsPolicy`，队列上限 512（`LogThreadPool`）
- **序列化兜底**：入参序列化失败会记录错误日志并置空数组（`LogAspect#around()`）
- **失败是否记录**：默认失败不记录；只有 `handleOnFail=true` 时，异常/失败才会进入记录分支（`OperationLog#handleOnFail` + `LogAspect#around()`）
- **Redis故障降级**：热力图和画像模块在 Redis 不可用时自动降级到本地缓存（`HeatmapServiceImpl` / `ProfileServiceImpl`）

## 5. 代码定位速查（已确认）

- 启用注解：`cn.creekmoon.operationLog.config.EnableOperationLog`
- 装配与启用：`cn.creekmoon.operationLog.config.OperationLogAutoConfiguration`
- 方法注解：`cn.creekmoon.operationLog.core.OperationLog`
- 切面：`cn.creekmoon.operationLog.core.LogAspect#around`
- 上下文：`cn.creekmoon.operationLog.core.OperationLogContext`（`follow/addTags/addRemarks/markFail`）
- 日志对象：`cn.creekmoon.operationLog.core.LogRecord`（`toFlatJson()`）
- 异步线程池：`cn.creekmoon.operationLog.core.LogThreadPool`
- 扩展点：`cn.creekmoon.operationLog.core.OperationLogHandler`、`cn.creekmoon.operationLog.core.OperationLogRecordInitializer`
- 默认实现：`config/DefaultOperationLogHandler`、`config/DefaultOperationLogRecordInitializer`
- 热力图服务：`heatmap/HeatmapService`、`heatmap/HeatmapServiceImpl`
- 画像服务：`profile/ProfileService`、`profile/ProfileServiceImpl`

## 6. 外部集成（已实现范围内）

- 组件自身不内置任何外部系统客户端；通过实现 `OperationLogHandler` 将 `LogRecord` 推送到 ES/DB/MQ 等（由使用方实现）。

## 7. 术语表（用于检索）

- `@EnableOperationLog`：启用 Starter（显式导入配置）
- `@OperationLog`：标记需要记录的 Controller 方法
- `LogAspect`：AOP 切面入口
- `LogRecord`：单次操作日志数据对象
- `OperationLogContext`：请求级 ThreadLocal 上下文（pre/after/tags/remarks/fail）
- `OperationLogRecordInitializer`：日志初始化扩展点（通常设置用户信息）
- `OperationLogHandler`：日志处理扩展点（存储/输出）
- `LogThreadPool`：异步执行处理器的线程池
- `HeatmapService`：热力图统计服务（PV/UV/TopN）
- `ProfileService`：用户画像服务（标签/统计）

## 8. 模块文档清单

- [模块-启用与装配](模块-启用与装配.md)
- [模块-AOP切面与采集](模块-AOP切面与采集.md)
- [模块-上下文与字段跟踪](模块-上下文与字段跟踪.md)
- [模块-异步处理与扩展点](模块-异步处理与扩展点.md)
- [模块-日志数据结构与序列化](模块-日志数据结构与序列化.md)
- [模块-操作热力图统计](模块-操作热力图统计.md)
- [模块-用户行为画像](模块-用户行为画像.md)

## 9. 最短阅读路径（按场景）

- **想知道如何启用/注册哪些 Bean**：先读 [模块-启用与装配](模块-启用与装配.md)
- **想知道拦截点与采集哪些字段**：先读 [模块-AOP切面与采集](模块-AOP切面与采集.md)
- **想知道 follow 前后值如何产生**：先读 [模块-上下文与字段跟踪](模块-上下文与字段跟踪.md)
- **想自定义推送/初始化用户信息**：先读 [模块-异步处理与扩展点](模块-异步处理与扩展点.md)
- **想知道接口 PV/UV 如何统计**：先读 [模块-操作热力图统计](模块-操作热力图统计.md)
- **想知道用户标签如何生成**：先读 [模块-用户行为画像](模块-用户行为画像.md)


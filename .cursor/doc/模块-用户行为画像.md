# 模块-用户行为画像

## 0. 模块目标

基于用户操作历史自动聚合统计，通过可配置的标签规则引擎生成用户标签，支持按标签筛选用户和查看用户操作分布。

## 1. 边界

- **包含**：用户操作计数、标签规则引擎（AND/OR 条件）、默认标签规则、标签反向索引、Redis 故障降级、Actuator 监控端点
- **不包含**：用户 demographic 信息（年龄/性别/地域）、机器学习预测、第三方画像数据集成

## 2. 可检索关键词

`ProfileService` / `ProfileCollector` / `ProfileProperties` / `ProfileActuatorEndpoint` / `TagRule` / `TagCondition` / `AND` / `OR` / `ORDER_QUERY` / `ORDER_SUBMIT` / `ORDER_REFUND` / 高频查询用户 / 高价值用户 / 潜在流失用户 / 高频退款用户 / `@OperationLog(profile = true)` / `/actuator/operation-log-profile`

## 3. 已实现能力(DONE)

- **用户操作自动聚合**：按操作类型（`operationType`）统计用户行为次数，存储于 Redis Hash（锚点：`ProfileServiceImpl#recordOperation`）
- **标签规则引擎**：支持 AND/OR 复合条件，可配置化无需改代码（锚点：`ProfileProperties#tagRules` / `TagRule` / `TagCondition`）
- **默认标签规则**：内置 4 种标签（锚点：`ProfileProperties#initDefaultTagRules`）
  - 高频查询用户：`ORDER_QUERY > 50`
  - 高价值用户：`ORDER_SUBMIT > 10 AND ORDER_REFUND < 2`
  - 潜在流失用户：`ORDER_QUERY > 30 AND ORDER_SUBMIT = 0`
  - 高频退款用户：`ORDER_REFUND > 5`
- **标签反向索引**：支持按标签查询用户列表（锚点：`ProfileServiceImpl#getUsersByTag`）
- **用户画像查询**：查看单个用户的操作分布和标签列表（锚点：`ProfileServiceImpl#getUserProfile`）
- **Redis 故障降级**：Redis 不可用时自动降级到本地缓存（锚点：`ProfileServiceImpl` 中 Redis 异常捕获分支）
- **标签自动刷新**：每天凌晨 2 点批量刷新所有用户标签（锚点：`HeatmapDataCleanupTask#refreshAllUserTags`）
- **Actuator 监控端点**：暴露 `/actuator/operation-log-profile/*` 供查询（锚点：`ProfileActuatorEndpoint`）
- **AOP 集成**：通过 `ProfileCollector` 在 `LogAspect` 中异步收集数据（锚点：`ProfileCollector#collect`）

## 4. 主要入口与关键类

- `cn.creekmoon.operationLog.profile.ProfileService` - 服务接口定义
- `cn.creekmoon.operationLog.profile.ProfileServiceImpl` - 服务实现（标签/统计核心）
- `cn.creekmoon.operationLog.profile.ProfileCollector` - 数据收集器（与 LogAspect 集成）
- `cn.creekmoon.operationLog.profile.ProfileProperties` - 配置属性类（含默认标签规则）
- `cn.creekmoon.operationLog.profile.ProfileActuatorEndpoint` - Actuator 监控端点
- `cn.creekmoon.operationLog.profile.TagRule` - 标签规则定义
- `cn.creekmoon.operationLog.profile.TagCondition` - 标签条件定义

## 5. 核心流程（高层）

1. 应用启动时 `HeatmapConfiguration` 条件装配所有组件（需 `operation-log.profile.enabled=true`）
2. `ProfileProperties#initDefaultTagRules` 初始化默认标签规则
3. Controller 方法标注 `@OperationLog(type = "XXX", profile = true)` 被调用
4. `LogAspect` 拦截后调用 `ProfileCollector#collect` 异步收集数据
5. `ProfileServiceImpl#recordOperation` 写入 Redis Hash（Key 格式：`profile:{userId}:{date}`）
6. `ProfileServiceImpl#evaluateTags` 根据规则引擎计算用户标签
7. 标签写入反向索引（Key 格式：`profile:tag:{tagName}`）
8. 每天凌晨 2 点 `HeatmapDataCleanupTask` 刷新所有用户标签
9. 通过 `ProfileActuatorEndpoint` 暴露查询接口

## 6. 外部依赖

- Redis（Hash 结构存储用户操作计数，Set 结构存储标签反向索引）
- Spring Boot Actuator
- Caffeine（本地降级缓存）

## 7. 模块协作点

- **触发点**：`LogAspect#around` 中调用 `ProfileCollector#collect`
- **输入**：`LogRecord`（提取 userId、operationType）
- **输出**：Redis Hash（用户操作计数）、Redis Set（标签反向索引）
- **一致性约束**：标签规则在应用启动时加载，运行期不变；统计窗口默认 30 天

## 8. 常见问题

- **为什么用户没有标签**：看 `ProfileProperties#tagEngineEnabled` 是否开启，以及用户操作数是否达到规则阈值
- **如何自定义标签规则**：在 `application.yml` 中配置 `operation-log.profile.tag-rules`，格式参考 `ProfileProperties#initDefaultTagRules`
- **如何查看某标签下的所有用户**：访问 `GET /actuator/operation-log-profile/tag/{tagName}`
- **标签统计的时间窗口是多久**：默认 30 天，可通过 `ProfileProperties#defaultStatsDays` 调整
- **为什么 Redis 挂了标签还能查**：看 `ProfileServiceImpl` 中 `try-catch` 包裹 Redis 操作的分支，降级到 `localCache`

# 模块-日志数据结构与序列化

## 0. 模块目标

定义一次“操作日志记录”的数据结构，并提供面向存储（如 ES）的一层打平序列化输出。

## 1. 边界

- **包含**：`LogRecord` 字段定义、`toFlatJson()` 的序列化策略、时间格式处理
- **不包含**：字段 diff 结果（当前结构仅承载 `preValue/afterValue`）

## 2. 可检索关键词

LogRecord / toFlatJson / LinkedHashSet tags remarks / requestParams JSONArray / operationTime LocalDateTime / UTC_MS_PATTERN / JSONObject.toJSONString

## 3. 已实现能力（DONE）

- **日志对象字段**：包含 userId/userName/projectName、操作信息、入参、结果、时间、标签、备注、前后值等（锚点：`cn.creekmoon.operationLog.core.LogRecord` 字段列表）
- **默认成功结果**：`requestResult` 默认值为 `Boolean.TRUE`（锚点：`LogRecord.requestResult = Boolean.TRUE`）
- **标签与备注有序去重**：`tags/remarks` 使用 `LinkedHashSet`（锚点：`LogRecord.tags`、`LogRecord.remarks`）
- **存储友好的打平输出**：`toFlatJson()` 遍历字段并输出到第一层 `JSONObject`；非字符串/数组等对象以 `JSONObject.toJSONString` 形式落盘（锚点：`LogRecord#toFlatJson`）
- **时间输出格式**：
  - `LocalDateTime`：以 `UTC_MS_PATTERN` 格式输出，并执行 `plusHours(-8)`（锚点：`toFlatJson` 的 `case LocalDateTime`）
  - `Date`：同样输出 `UTC_MS_PATTERN`，并使用 `GMT+:08:00` 时区（锚点：`toFlatJson` 的 `case Date`）
- **JSONArray 输出**：`JSONArray` 被输出为其 `toJSONString()`（锚点：`toFlatJson` 的 `case JSONArray`）

## 4. 主要入口与关键类

- `cn.creekmoon.operationLog.core.LogRecord`
- `cn.creekmoon.operationLog.core.LogAspect#around`（写入 requestParams/methodName/classFullName/operationName/requestResult/pre/after/tags/remarks）
- `cn.creekmoon.operationLog.core.OperationLogContext`（写入 tags/remarks/markFail/follow）

## 5. 外部依赖

- Hutool（`DateUtil`、`ReflectUtil`、`FastDateFormat`）
- Fastjson2（`JSONObject`、`JSONArray`）

## 6. 模块协作点

- `operationType` 字段当前未在切面中赋值，只有当使用方在初始化器或后置钩子中赋值时才会有值（锚点：`LogRecord.operationType` 存在，但工程内无 `setOperationType` 调用）

## 7. 常见问题（优先看哪里）

- **为什么时间看起来像 UTC 但又有 8 小时偏移**：优先看 `LogRecord#toFlatJson` 的 `LocalDateTime plusHours(-8)` 与 `Date` 的时区格式化逻辑

